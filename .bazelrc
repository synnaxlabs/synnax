# Disable Bzlmod (Bazel Modules)
# We need the last flag to avoid issues with rules_proto_grpc
# See https://github.com/rules-proto-grpc/rules_proto_grpc/issues/390 for info
common --enable_bzlmod=true --enable_workspace=false --noincompatible_disallow_ctx_resolve_tools  --define=protobuf_allow_msvc=true

# Enable platform-specific configs
build --enable_platform_specific_config

# These hide symbols from the linker in order to prevent symbols collisions with
# libraries we load dynamically at runtime (LabJack is the primary source of this issue,
# as it relies an incompatible, legacy GRPC version).
build:hide_symbols --copt=-fvisibility=hidden --cxxopt=-fvisibility-inlines-hidden

# ===== Platform-Specific Compiler Settings =====

# macOS (Apple Silicon)
build:macos --cpu=darwin_arm64
build:macos --cxxopt=-std=c++20
build:macos --host_cxxopt=-std=c++20
build:macos --copt=-Werror

# Linux
build:linux --cxxopt=-std=c++17
build:linux --host_cxxopt=-std=c++17
build:linux --copt=-Werror

# Windows (MSVC)
build:windows --enable_runfiles
build:windows --cxxopt=/std:c++20
build:windows --host_cxxopt=/std:c++20
build:windows --copt=/W3     # Use warning level 3 instead of -Wall (which is /W4 + extras on MSVC)
build:windows --cxxopt=/W3   # Same for C++
build:windows --copt=/WX     # Treat warnings as errors
build:windows --copt=/wd4514  # 'function': unreferenced inline function has been removed (common in headers)
build:windows --copt=/wd5039  # pointer/reference to potentially throwing function passed to extern C (Windows SDK headers)
build:windows --copt=/wd4710  # 'function': function not inlined (informational)
build:windows --copt=/wd4711  # function 'function' selected for automatic inline expansion (informational)
build:windows --copt=/wd4946  # reinterpret_cast used between related classes (abseil-cpp)
build:windows --copt=/wd5243  # using incomplete type with member function pointer (protobuf)
build:windows --copt=/wd5045  # Compiler will insert Spectre mitigation (informational)
build:windows --copt=/wd4267  # 'var' : conversion from 'size_t' to 'type', possible loss of data (protobuf headers)
build:windows --copt=/wd4244  # conversion from 'type1' to 'type2', possible loss of data (protobuf headers)
build:windows --copt=/wd4371  # layout of class may have changed from a previous version (protobuf/STL)
build:windows --copt=/wd4868  # compiler may not enforce left-to-right evaluation order in braced initializer list
build:windows --copt=/wd4866  # compiler may not enforce left-to-right evaluation order for function calls
build:windows --copt=/wd4702  # unreachable code (common with if constexpr in templates)
build:windows --copt=/wd4355  # 'this': used in base member initializer list (gRPC headers)
build:windows --copt=/wd4365  # conversion from one type to another, signed/unsigned mismatch (STL/gRPC interaction)
build:windows --per_file_copt=external/.*@/WX-,/w
build:windows --per_file_copt=vendor/.*@/WX-,/w

# ===== Warning Suppression for External Dependencies =====

# Only show output from workspace targets (filters out external dependency noise)
build --output_filter=^//

# Suppress warnings from external dependencies (Bazel modules and vendor/)
build --per_file_copt=external/.*@-w
build --per_file_copt=.*\\.cache/bazel/.*@-w
build --per_file_copt=vendor/.*@-w

# Keep strict warnings for workspace code (but not on Windows where -Wall is too verbose)
build --copt=-Wall
build --cxxopt=-Wall

# ===== Optimization Flags (used with -c opt) =====

build:opt --compilation_mode=opt
build:opt --strip=always

# Platform-agnostic optimization
build:opt --copt=-O3
build:opt --copt=-flto
build:opt --linkopt=-flto
# Disable Bzlmod (Bazel Modules)
# We need the last flag to avoid issues with rules_proto_grpc
# See https://github.com/rules-proto-grpc/rules_proto_grpc/issues/390 for info
common --enable_bzlmod=true --enable_workspace=false --noincompatible_disallow_ctx_resolve_tools  --define=protobuf_allow_msvc=true

# Enable platform-specific configs
build --enable_platform_specific_config

# These hide symbols from the linker in order to prevent symbols collisions with
# libraries we load dynamically at runtime (LabJack is the primary source of this issue,
# as it relies an incompatible, legacy GRPC version).
build:hide_symbols --copt=-fvisibility=hidden --cxxopt=-fvisibility-inlines-hidden

# ===== Platform-Specific Compiler Settings =====

# macOS (Apple Silicon)
build:macos --cpu=darwin_arm64
build:macos --cxxopt=-std=c++23
build:macos --host_cxxopt=-std=c++23
build:macos --copt=-Werror

# Allow protobuf deprecation warnings without treating them as errors
build:macos --copt=-Wno-error=deprecated-declarations

# Linux
build:linux --cxxopt=-std=c++23
build:linux --host_cxxopt=-std=c++23
build:linux --copt=-Werror

# Allow protobuf deprecation warnings without treating them as errors
build:linux --copt=-Wno-error=deprecated-declarations

# Allow sequence-point warnings without treating them as errors
# (wasmtime headers use storage++ in pack expansion which triggers this)
build:linux --copt=-Wno-error=sequence-point

# Windows (MSVC)
# Note: MSVC uses /std:c++latest for C++23 features (not /std:c++23)
build:windows --enable_runfiles
build:windows --cxxopt=/std:c++latest
build:windows --host_cxxopt=/std:c++latest
build:windows --copt=/Zc:preprocessor      # Enable C++20 conformant preprocessor (for __VA_OPT__)
build:windows --copt=/W3     # Use warning level 3 instead of -Wall (which is /W4 + extras on MSVC)
build:windows --cxxopt=/W3   # Same for C++
build:windows --copt=/WX     # Treat warnings as errors
build:windows --copt=/wd4514  # 'function': unreferenced inline function has been removed (common in headers)
build:windows --copt=/wd5039  # pointer/reference to potentially throwing function passed to extern C (Windows SDK headers)
build:windows --copt=/wd4710  # 'function': function not inlined (informational)
build:windows --copt=/wd4711  # function 'function' selected for automatic inline expansion (informational)
build:windows --copt=/wd4946  # reinterpret_cast used between related classes (abseil-cpp)
build:windows --copt=/wd5243  # using incomplete type with member function pointer (protobuf)
build:windows --copt=/wd5045  # Compiler will insert Spectre mitigation (informational)
build:windows --copt=/wd4267  # 'var' : conversion from 'size_t' to 'type', possible loss of data (protobuf headers)
build:windows --copt=/wd4244  # conversion from 'type1' to 'type2', possible loss of data (protobuf headers)
build:windows --copt=/wd4371  # layout of class may have changed from a previous version (protobuf/STL)
build:windows --copt=/wd4868  # compiler may not enforce left-to-right evaluation order in braced initializer list
build:windows --copt=/wd4866  # compiler may not enforce left-to-right evaluation order for function calls
build:windows --copt=/wd4702  # unreachable code (common with if constexpr in templates)
build:windows --copt=/wd4355  # 'this': used in base member initializer list (gRPC headers)
build:windows --copt=/wd4365  # conversion from one type to another, signed/unsigned mismatch (STL/gRPC interaction)
build:windows --copt=/wd4820  # padding added after data member (GoogleTest)
build:windows --copt=/wd4625  # copy constructor implicitly deleted (GoogleTest)
build:windows --copt=/wd4626  # assignment operator implicitly deleted (GoogleTest)
build:windows --copt=/wd5026  # move constructor implicitly deleted (GoogleTest)
build:windows --copt=/wd5027  # move assignment operator implicitly deleted (GoogleTest)
build:windows --copt=/wd4458  # declaration hides class member
build:windows --copt=/wd4388  # signed/unsigned mismatch
build:windows --copt=/wd4389  # signed/unsigned mismatch
build:windows --copt=/wd4582  # constructor not implicitly called
build:windows --copt=/wd4623  # default constructor implicitly deleted
build:windows --copt=/wd4100  # unreferenced formal parameter
build:windows --copt=/wd4800  # implicit conversion to bool
build:windows --copt=/wd4127  # conditional expression is constant
build:windows --copt=/wd4018  # signed/unsigned mismatch
build:windows --copt=/wd5267  # definition of implicit copy constructor is deprecated
build:windows --copt=/wd5219  # implicit conversion, possible loss of data
build:windows --copt=/wd4305  # truncation from double to float
build:windows --copt=/wd4242  # conversion with possible loss of data
build:windows --copt=/wd4668  # 'macro' not defined as preprocessor macro (Windows SDK headers)
build:windows --copt=/wd5220  # volatile qualified type no longer implies trivial constructors (open62541)
build:windows --copt=/wd4146  # unary minus operator applied to unsigned type (telem templates)
build:windows --copt=/wd4061  # enumerator not explicitly handled by case label (mbedtls headers)
build:windows --copt=/wd4435  # object layout under /vd2 will change due to virtual base (NI channel hierarchy)
build:windows --copt=/wd4589  # constructor ignores initializer for virtual base class (NI channel hierarchy)
build:windows --copt=/wd4201  # nonstandard extension used: nameless struct/union (wasmtime headers)
build:windows --copt=/wd4324  # structure was padded due to alignment specifier (queue/spsc.h)
build:windows --copt=/wd4005  # macro redefinition (SOEM wpcap headers vs Windows SDK)
build:windows --per_file_copt=external/.*@/WX-,/w
build:windows --per_file_copt=vendor/.*@/WX-,/w

# Allow protobuf deprecation warnings without treating them as errors
build:windows --copt=/wd4996  # disables warning C4996 (deprecated declarations) for MSVC

# Use a fixed PATH so that different shell environments (e.g. with/without a Python venv
# activated) don't invalidate the entire action cache.
build --incompatible_strict_action_env
build:macos --action_env=PATH=/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
build:linux --action_env=PATH=/usr/local/bin:/usr/bin:/bin
# On Windows, inherit PATH from the host environment since tool install locations vary
# more across machines (CMake, Git, MSVC, etc.)
build:windows --action_env=PATH

# ===== Warning Suppression for External Dependencies =====

# Only show output from workspace targets (filters out external dependency noise)
build --output_filter=^//

# Suppress warnings from external dependencies (Bazel modules and vendor/)
build --per_file_copt=external/.*@-w
build --per_file_copt=.*\\.cache/bazel/.*@-w
build --per_file_copt=vendor/.*@-w

# Keep strict warnings for workspace code (but not on Windows where -Wall is too verbose)
build --copt=-Wall
build --cxxopt=-Wall

# ===== Optimization Flags (used with --config=opt) =====
#
# Use --config=opt for release builds. This enables:
# - compilation_mode=opt (Bazel's optimization mode)
# - Symbol stripping
#
# For maximum optimization, also add platform-specific config:
# - macOS/Linux: --config=opt --config=opt-unix
# - Windows: --config=opt --config=opt-windows

# Base optimization settings (platform-agnostic)
build:opt --compilation_mode=opt
build:opt --strip=always

# Unix optimization (macOS/Linux with GCC/Clang)
# -O3: Maximum optimization level
# -flto: Link-Time Optimization for cross-module inlining
build:opt-unix --copt=-O3
build:opt-unix --copt=-flto
build:opt-unix --linkopt=-flto

# Windows optimization (MSVC)
# /O2: Maximum speed optimization
# /GL: Whole Program Optimization (compile-time cross-module optimization)
# /LTCG: Link-Time Code Generation (link-time optimization)
build:opt-windows --copt=/O2
build:opt-windows --copt=/GL
build:opt-windows --linkopt=/LTCG

# ===== Sanitizers (Memory/Undefined Behavior Detection) =====

# AddressSanitizer (ASan) - Detects memory errors
# - Heap/stack buffer overflows
# - Use-after-free
# - Double-free
# - Memory leaks (via LeakSanitizer on Linux only)
build:asan --copt=-fsanitize=address
build:asan --copt=-fno-omit-frame-pointer
build:asan --copt=-O1
build:asan --copt=-g
build:asan --copt=-fno-optimize-sibling-calls
build:asan --copt=-fdebug-prefix-map=/proc/self/cwd=.
build:asan --linkopt=-fsanitize=address
build:asan --action_env=ASAN_OPTIONS=abort_on_error=1:halt_on_error=1:detect_stack_use_after_return=1
build:asan --test_env=ASAN_OPTIONS=abort_on_error=1:halt_on_error=1:detect_stack_use_after_return=1
build:asan --test_timeout=120,600,1800,3600  # ASan adds ~2-3x overhead

# macOS-specific: Suppress _FORTIFY_SOURCE redefinition warning (ASan defines it to 0)
build:asan --copt=-Wno-macro-redefined

# ASan with LeakSanitizer (Linux only - LSan not supported on macOS/Windows)
build:asan-leak --config=asan
build:asan-leak --copt=-fsanitize=leak
build:asan-leak --linkopt=-fsanitize=leak
build:asan-leak --action_env=ASAN_OPTIONS=detect_leaks=1:abort_on_error=1:halt_on_error=1:detect_stack_use_after_return=1
build:asan-leak --test_env=ASAN_OPTIONS=detect_leaks=1:abort_on_error=1:halt_on_error=1:detect_stack_use_after_return=1
build:asan-leak --action_env=LSAN_OPTIONS=exitcode=0
build:asan-leak --test_env=LSAN_OPTIONS=exitcode=0

# LeakSanitizer (LSan) - Standalone leak detection (Linux only)
build:lsan --copt=-fsanitize=leak
build:lsan --copt=-fno-omit-frame-pointer
build:lsan --copt=-g
build:lsan --copt=-fdebug-prefix-map=/proc/self/cwd=.
build:lsan --linkopt=-fsanitize=leak
build:lsan --action_env=LSAN_OPTIONS=suppressions=scripts/sanitizers/lsan_suppressions.txt
build:lsan --test_env=LSAN_OPTIONS=suppressions=scripts/sanitizers/lsan_suppressions.txt

# UndefinedBehaviorSanitizer (UBSan) - Detects undefined behavior
# - Integer overflow
# - Null pointer dereference
# - Misaligned pointer access
# - Division by zero
# - Invalid enum values
build:ubsan --copt=-fsanitize=undefined
build:ubsan --copt=-fno-sanitize-recover=undefined
build:ubsan --copt=-fno-omit-frame-pointer
build:ubsan --copt=-g
build:ubsan --copt=-fdebug-prefix-map=/proc/self/cwd=.
build:ubsan --linkopt=-fsanitize=undefined
build:ubsan --action_env=UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1
build:ubsan --test_env=UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1

# Combined sanitizers (recommended for local development)
build:sanitize --config=asan
build:sanitize --config=ubsan

# Sanitizers for CI (optimized settings)
build:sanitize-ci --config=sanitize
build:sanitize-ci --test_output=errors
build:sanitize-ci --test_summary=detailed

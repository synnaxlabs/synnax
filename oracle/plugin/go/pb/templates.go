// Copyright 2025 Synnax Labs, Inc.
//
// Use of this software is governed by the Business Source License included in the file
// licenses/BSL.txt.
//
// As of the Change Date specified in that file, in accordance with the Business Source
// License, use of this software will be governed by the Apache License, Version 2.0,
// included in the file licenses/APL.txt.

package pb

import (
	"strings"
	"text/template"
)

var templateFuncs = template.FuncMap{
	"join":    strings.Join,
	"lcFirst": lcFirst,
}

// lcFirst lowercases the first character of a string.
func lcFirst(s string) string {
	if s == "" {
		return s
	}
	return strings.ToLower(s[:1]) + s[1:]
}

// translatorFileTemplate generates a Go file with translator functions.
var translatorFileTemplate = template.Must(template.New("go-pb-translator").Funcs(templateFuncs).Parse(`// Code generated by oracle. DO NOT EDIT.

package {{.Package}}
{{- if .HasImports}}

import (
{{- range .ExternalImports}}
	"{{.}}"
{{- end}}
{{- if and (gt (len .ExternalImports) 0) (gt (len .InternalImports) 0)}}

{{- end}}
{{- range .InternalImports}}
{{- if .NeedsAlias}}
	{{.Alias}} "{{.Path}}"
{{- else}}
	"{{.Path}}"
{{- end}}
{{- end}}
)
{{- end}}
{{range .Translators}}

// {{.Name}}ToPB converts {{.GoTypeShort}} to {{.PBTypeShort}}.
func {{.Name}}ToPB({{if .UsesContext}}ctx{{else}}_{{end}} context.Context, r {{.GoType}}) (*{{.PBType}}, error) {
{{- range .ErrorFields}}
	{{lcFirst .GoName}}Val, err := {{.ForwardExpr}}
	if err != nil {
		return nil, err
	}
{{- end}}
	pb := &{{.PBType}}{
{{- range .Fields}}
		{{.PBName}}: {{.ForwardExpr}},
{{- end}}
{{- range .ErrorFields}}
		{{.PBName}}: {{lcFirst .GoName}}Val,
{{- end}}
	}
{{- range .OptionalFields}}
	if r.{{.GoName}} != nil {
{{- if .IsOptionalStruct}}
		var err error
		pb.{{.PBName}}, err = {{.ForwardExpr}}
		if err != nil {
			return nil, err
		}
{{- else}}
		pb.{{.PBName}} = {{.ForwardExpr}}
{{- end}}
	}
{{- end}}
	return pb, nil
}

// {{.Name}}FromPB converts {{.PBTypeShort}} to {{.GoTypeShort}}.
func {{.Name}}FromPB({{if .UsesContext}}ctx{{else}}_{{end}} context.Context, pb *{{.PBType}}) ({{.GoType}}, error) {
	var r {{.GoType}}
	if pb == nil {
		return r, nil
	}
{{- $needsErr := false}}
{{- range .ErrorFields}}{{if .HasBackwardError}}{{$needsErr = true}}{{end}}{{end}}
{{- if $needsErr}}
	var err error
{{- end}}
{{- range .ErrorFields}}
{{- if .HasBackwardError}}
	r.{{.GoName}}, err = {{.BackwardExpr}}
	if err != nil {
		return r, err
	}
{{- else}}
	r.{{.GoName}} = {{.BackwardExpr}}
{{- end}}
{{- end}}
{{- range .Fields}}
	r.{{.GoName}} = {{.BackwardExpr}}
{{- end}}
{{- range .OptionalFields}}
	if pb.{{.PBName}} != nil {
{{- if .IsOptionalStruct}}
		val, err := {{.BackwardExpr}}
		if err != nil {
			return r, err
		}
{{- if .BackwardCast}}
		r.{{.GoName}} = {{.BackwardCast}}(&val)
{{- else}}
		r.{{.GoName}} = &val
{{- end}}
{{- else}}
		r.{{.GoName}} = {{.BackwardExpr}}
{{- end}}
	}
{{- end}}
	return r, nil
}

// {{.Name}}sToPB converts a slice of {{.GoTypeShort}} to {{.PBTypeShort}}.
func {{.Name}}sToPB(ctx context.Context, rs []{{.GoType}}) ([]*{{.PBType}}, error) {
	result := make([]*{{.PBType}}, len(rs))
	for i := range rs {
		var err error
		result[i], err = {{.Name}}ToPB(ctx, rs[i])
		if err != nil {
			return nil, err
		}
	}
	return result, nil
}

// {{.Name}}sFromPB converts a slice of {{.PBTypeShort}} to {{.GoTypeShort}}.
func {{.Name}}sFromPB(ctx context.Context, pbs []*{{.PBType}}) ([]{{.GoType}}, error) {
	result := make([]{{.GoType}}, len(pbs))
	for i, pb := range pbs {
		var err error
		result[i], err = {{.Name}}FromPB(ctx, pb)
		if err != nil {
			return nil, err
		}
	}
	return result, nil
}
{{- end}}
{{- range .EnumTranslators}}

// Translate{{.Name}}Forward converts {{.GoType}} to {{.PBType}}.
func Translate{{.Name}}Forward(v {{.GoType}}) {{.PBType}} {
	switch v {
{{- range .Values}}
	case {{.GoValue}}:
		return {{.PBValue}}
{{- end}}
	default:
		return {{.PBDefault}}
	}
}

// Translate{{.Name}}Backward converts {{.PBType}} to {{.GoType}}.
func Translate{{.Name}}Backward(v {{.PBType}}) {{.GoType}} {
	switch v {
{{- range .Values}}
	case {{.PBValue}}:
		return {{.GoValue}}
{{- end}}
	default:
		return {{.GoDefault}}
	}
}
{{- end}}
{{- range .GenericTranslators}}

// {{.Name}}ToPB converts {{.GoTypeShort}} to {{.PBTypeShort}} using provided type converters.
func {{.Name}}ToPB[{{range $i, $tp := .TypeParams}}{{if $i}}, {{end}}{{$tp.Name}} {{$tp.Constraint}}{{end}}](
	{{if .UsesContext}}ctx{{else}}_{{end}} context.Context,
	r {{.GoType}},
{{- range .TypeParams}}
	translate{{.Name}} func(context.Context, {{.Name}}) (*anypb.Any, error),
{{- end}}
) (*{{.PBType}}, error) {
{{- range .TypeParamFields}}
	{{lcFirst .GoName}}Any, err := {{.ForwardExpr}}
	if err != nil {
		return nil, err
	}
{{- end}}
{{- range .ErrorFields}}
	{{lcFirst .GoName}}Val, err := {{.ForwardExpr}}
	if err != nil {
		return nil, err
	}
{{- end}}
	pb := &{{.PBType}}{
{{- range .Fields}}
		{{.PBName}}: {{.ForwardExpr}},
{{- end}}
{{- range .TypeParamFields}}
		{{.PBName}}: {{lcFirst .GoName}}Any,
{{- end}}
{{- range .ErrorFields}}
		{{.PBName}}: {{lcFirst .GoName}}Val,
{{- end}}
	}
{{- range .OptionalFields}}
	if r.{{.GoName}} != nil {
		pb.{{.PBName}} = {{.ForwardExpr}}
	}
{{- end}}
	return pb, nil
}

// {{.Name}}FromPB converts {{.PBTypeShort}} to {{.GoTypeShort}} using provided type converters.
func {{.Name}}FromPB[{{range $i, $tp := .TypeParams}}{{if $i}}, {{end}}{{$tp.Name}} {{$tp.Constraint}}{{end}}](
	{{if .UsesContext}}ctx{{else}}_{{end}} context.Context,
	pb *{{.PBType}},
{{- range .TypeParams}}
	translate{{.Name}} func(context.Context, *anypb.Any) ({{.Name}}, error),
{{- end}}
) ({{.GoType}}, error) {
	var r {{.GoType}}
	if pb == nil {
		return r, nil
	}
{{- $needsErr := false}}
{{- range .TypeParamFields}}{{$needsErr = true}}{{end}}
{{- range .ErrorFields}}{{if .HasBackwardError}}{{$needsErr = true}}{{end}}{{end}}
{{- if $needsErr}}
	var err error
{{- end}}
{{- range .TypeParamFields}}
	r.{{.GoName}}, err = {{.BackwardExpr}}
	if err != nil {
		return r, err
	}
{{- end}}
{{- range .ErrorFields}}
{{- if .HasBackwardError}}
	r.{{.GoName}}, err = {{.BackwardExpr}}
	if err != nil {
		return r, err
	}
{{- else}}
	r.{{.GoName}} = {{.BackwardExpr}}
{{- end}}
{{- end}}
{{- range .Fields}}
	r.{{.GoName}} = {{.BackwardExpr}}
{{- end}}
{{- range .OptionalFields}}
	if pb.{{.PBName}} != nil {
		r.{{.GoName}} = {{.BackwardExpr}}
	}
{{- end}}
	return r, nil
}
{{- end}}
{{- range .AnyHelpers}}

// {{.TypeName}}ToPBAny converts {{.TypeName}} to *anypb.Any for use with generic translators.
func {{.TypeName}}ToPBAny(ctx context.Context, v {{.GoType}}) (*anypb.Any, error) {
	pb, err := {{.TypeName}}ToPB(ctx, v)
	if err != nil {
		return nil, err
	}
	return anypb.New(pb)
}

// {{.TypeName}}FromPBAny converts *anypb.Any to {{.TypeName}} for use with generic translators.
func {{.TypeName}}FromPBAny(ctx context.Context, a *anypb.Any) ({{.GoType}}, error) {
	if a == nil {
		return {{.GoType}}{}, nil
	}
	var pb {{.PBType}}
	if err := a.UnmarshalTo(&pb); err != nil {
		return {{.GoType}}{}, err
	}
	return {{.TypeName}}FromPB(ctx, &pb)
}
{{- end}}
`))

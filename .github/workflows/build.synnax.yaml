name: Build - Synnax

run-name:
  ${{ github.event.inputs.RUN_NAME || format('Build Synnax - {0}', github.ref_name) }}

on:
  workflow_dispatch:
    inputs:
      windows:
        description: "Platform: Windows"
        type: boolean
        default: false
      macos:
        description: "Platform: macOS"
        type: boolean
        default: false
      ubuntu:
        description: "Platform: Ubuntu"
        type: boolean
        default: false
      ubuntu_22_04:
        description: "Platform: NI Linux RT (Ubuntu 22.04)"
        type: boolean
        default: false
      docker:
        description: "Platform: Docker"
        type: boolean
        default: false
      driver:
        description: "Build: Driver"
        type: boolean
        default: false
      console:
        description: "Build: Console Web Assets"
        type: boolean
        default: false
      console_tauri:
        description: "Build: Console Tauri Desktop App"
        type: boolean
        default: false
      core:
        description: "Build: Core"
        type: boolean
        default: false
      sign_binaries:
        description: "Sign binaries (macOS + Windows)"
        type: boolean
        default: false
      upload_to_release:
        description: "Upload to GitHub release"
        type: boolean
        default: false
      use_simple_artifact_names:
        description: "Use simple artifact names (e.g., synnax-core-linux)"
        type: boolean
        default: false
      RUN_NAME:
        description: "Custom name for run"
        required: false
        default: ""
        type: string

  workflow_call:
    inputs:
      windows:
        type: boolean
        default: false
      macos:
        type: boolean
        default: false
      ubuntu:
        type: boolean
        default: false
      ubuntu_22_04:
        type: boolean
        default: false
      docker:
        type: boolean
        default: false
      driver:
        type: boolean
        default: false
      console:
        type: boolean
        default: false
      console_tauri:
        type: boolean
        default: false
      core:
        type: boolean
        default: false
      sign_binaries:
        type: boolean
        default: false
      upload_to_release:
        type: boolean
        default: false
      use_simple_artifact_names:
        type: boolean
        default: false
      version:
        type: string
        required: false
        default: ""

env:
  BAZEL_REMOTE_CACHE: ${{ vars.BAZEL_REMOTE_CACHE_URL }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      PURE_VERSION: ${{ steps.version.outputs.PURE_VERSION }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      console_tauri_matrix: ${{ steps.set-console-tauri-matrix.outputs.matrix }}
      GO_BUILD_TAGS: ${{ steps.go-tags.outputs.GO_BUILD_TAGS }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Get Version
        id: version
        working-directory: core
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Extract pure version by removing any suffix (-rc, -branch, etc.)
            PURE_VERSION=$(echo "${{ inputs.version }}" | sed 's/-.*$//')
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "PURE_VERSION=${PURE_VERSION}" >> $GITHUB_OUTPUT
          else
            BASE_VERSION=$(cat pkg/version/VERSION)
            echo "PURE_VERSION=${BASE_VERSION}" >> $GITHUB_OUTPUT
            if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
              echo "VERSION=${BASE_VERSION}" >> $GITHUB_OUTPUT
            elif [ "${GITHUB_REF}" == "refs/heads/rc" ]; then
              echo "VERSION=${BASE_VERSION}-rc" >> $GITHUB_OUTPUT
            else
              BRANCH_NAME="${GITHUB_REF#refs/heads/}"
              echo "VERSION=${BASE_VERSION}-${BRANCH_NAME}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate OS Matrix
        id: set-matrix
        run: |
          MATRIX=$(scripts/generate_os_matrix.sh "${{ inputs.windows }}" "${{ inputs.macos }}" "${{ inputs.ubuntu }}" "${{ inputs.ubuntu_22_04 }}")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Generate Console Tauri Matrix
        id: set-console-tauri-matrix
        run: |
          OS_LIST=""
          if [ "${{ inputs.macos }}" = "true" ]; then
            OS_LIST="\"macos-latest\""
          fi
          if [ "${{ inputs.windows }}" = "true" ]; then
            [ -n "$OS_LIST" ] && OS_LIST="$OS_LIST,"
            OS_LIST="${OS_LIST}\"windows-latest\""
          fi
          echo "matrix=[${OS_LIST}]" >> $GITHUB_OUTPUT

      - name: Verify Build Configuration
        run: |
          scripts/verify_build_config.sh \
            "${{ steps.version.outputs.VERSION }}" \
            "${{ inputs.windows }}" \
            "${{ inputs.macos }}" \
            "${{ inputs.ubuntu }}" \
            "${{ inputs.ubuntu_22_04 }}" \
            "${{ inputs.docker }}" \
            "${{ inputs.driver }}" \
            "${{ inputs.console }}" \
            "${{ inputs.console_tauri }}" \
            "${{ inputs.core }}"

      - name: Generate Go Build Tags
        id: go-tags
        run: |
          TAGS=""
          if [ "${{ inputs.console }}" = "true" ]; then TAGS="console"; fi
          if [ "${{ inputs.driver }}" = "true" ]; then TAGS="${TAGS:+$TAGS,}driver"; fi
          if [ -n "$TAGS" ]; then TAGS="-tags $TAGS"; fi
          echo "GO_BUILD_TAGS=$TAGS" >> $GITHUB_OUTPUT

  build:
    name: Build (${{ matrix.os }})
    needs: setup
    if: needs.setup.outputs.matrix != '[]'
    timeout-minutes: 75
    permissions:
      contents: write
      packages: write
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
      GH_TOKEN: ${{ github.token }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          clean: false

      - name: Update Submodules
        run: git submodule update --init --recursive

      - name: Install Deps On Ubuntu
        # Dependencies should already be installed on the machine.
        # This is nominally a no-op, but exists as a fallback and for documentation.
        if: matrix.os == 'ubuntu-build-bot' || matrix.os == 'ubuntu-2204-build-bot'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsystemd-dev autoconf automake libtool

      - name: Install Deps on macOS
        # Dependencies should already be installed on the machine.
        # This is nominally a no-op, but exists as a fallback and for documentation.
        if: matrix.os == 'macos-build-bot'
        run: brew install autoconf automake libtool 2>/dev/null

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          # Use S3 cache instead of github cache.
          bazelisk-cache: false
          disk-cache: false
          repository-cache: false

      - name: Build Driver
        if: inputs.driver
        shell: bash
        run: |
          BAZEL_FLAGS=""
          BAZEL_STARTUP_FLAGS=""

          if [ "${{ matrix.os }}" = "windows-build-bot" ]; then
            # Disable Git Bash path conversion (// -> / mangling)
            export MSYS_NO_PATHCONV=1
            BAZEL_STARTUP_FLAGS="--output_user_root=C:/tmp"
          elif [ "${{ matrix.os }}" = "ubuntu-2204-build-bot" ]; then
            export TMPDIR=/tmp
            BAZEL_FLAGS="--define=platform=nilinuxrt"
          else
            BAZEL_FLAGS="--config=hide_symbols"
          fi

          # macOS runners are not on AWS, so local cache is faster
          if [ "${{ matrix.os }}" != "macos-build-bot" ]; then
            BAZEL_FLAGS="$BAZEL_FLAGS --remote_cache=${{ env.BAZEL_REMOTE_CACHE }}"
          fi

          bazel $BAZEL_STARTUP_FLAGS build --enable_platform_specific_config -c opt --announce_rc --verbose_failures $BAZEL_FLAGS //driver

      - name: Import Apple Developer Certificate
        if: inputs.sign_binaries && matrix.os == 'macos-build-bot'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: build-${{ github.run_id }}.keychain
        run: |
          # Unique keychain per workflow run, which allows multiple runner instances
          # on the same machine to run simultaneously without conflicts.
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security delete-keychain $KEYCHAIN_NAME 2>/dev/null || true
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_NAME
          security list-keychains -d user -s $KEYCHAIN_NAME $(security list-keychains -d user | tr -d '"')
          security default-keychain -s $KEYCHAIN_NAME
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_NAME
          security set-keychain-settings -t 3600 -u $KEYCHAIN_NAME
          security import certificate.p12 -k $KEYCHAIN_NAME -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_NAME
          echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> $GITHUB_ENV

      - name: Sign macOS Driver Binary
        if: inputs.sign_binaries && inputs.driver && matrix.os == 'macos-build-bot'
        run: |
          cat > driver-entitlements.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
          </dict>
          </plist>
          EOF

          CERT_INFO=$(security find-identity -v -p codesigning $KEYCHAIN_NAME | grep "Developer ID Application")
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          codesign --force --options runtime --timestamp --entitlements driver-entitlements.plist --sign "$CERT_ID" bazel-bin/driver/driver
          codesign --verify --verbose bazel-bin/driver/driver

      - name: Notarize macOS Driver Binary
        if: inputs.sign_binaries && inputs.driver && matrix.os == 'macos-build-bot'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create a zip for notarization (notarytool requires a container format)
          zip -j driver-notarize.zip bazel-bin/driver/driver
          xcrun notarytool submit driver-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          rm driver-notarize.zip

      - name: Download relic for Windows signing
        if: inputs.sign_binaries && matrix.os == 'windows-build-bot'
        shell: bash
        run: |
          curl -L -o relic.exe https://github.com/sassoftware/relic/releases/latest/download/relic-windows-amd64.exe

      - name: Add relic to PATH
        if: inputs.sign_binaries && matrix.os == 'windows-build-bot'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path relic-bin
          Move-Item -Force relic.exe relic-bin\
          echo "${{ github.workspace }}\relic-bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Sign Windows Driver Binary
        if: inputs.sign_binaries && inputs.driver && matrix.os == 'windows-build-bot'
        shell: powershell
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          $bin = "bazel-bin\driver\driver.exe"
          Start-Sleep -Seconds 2
          attrib -R -S -H -A $bin
          takeown /F $bin | Out-Null
          icacls $bin /grant "*S-1-1-0:(F)" /inheritance:e | Out-Null
          $max = 5
          for ($i = 1; $i -le $max; $i++) {
            try {
              relic sign --file $bin --key azure --config relic.conf
              break
            } catch {
              if ($i -eq $max) { throw }
              Start-Sleep -Seconds 3
            }
          }

      - name: Rename Driver Binary
        if: inputs.driver
        shell: bash
        run: |
          mv bazel-bin/driver/driver${{ matrix.executable }} bazel-bin/driver/synnax-driver-v${{ needs.setup.outputs.VERSION }}-${{ matrix.os-name }}${{ matrix.executable }}

      - name: Upload Driver Binary as Artifact
        if: inputs.driver
        uses: actions/upload-artifact@v4
        with:
          name:
            ${{ inputs.use_simple_artifact_names && format('synnax-driver-{0}',
            matrix.os-name) || format('synnax-driver-v{0}-{1}',
            needs.setup.outputs.VERSION, matrix.os-name) }}
          path:
            bazel-bin/driver/synnax-driver-v${{ needs.setup.outputs.VERSION }}-${{
            matrix.os-name }}${{ matrix.executable }}
          retention-days: 7
          if-no-files-found: error

      - name: Upload Driver to Release
        if: inputs.driver && inputs.upload_to_release
        run: |
          gh release upload --clobber synnax-v${{ needs.setup.outputs.VERSION }} bazel-bin/driver/synnax-driver-v${{ needs.setup.outputs.VERSION }}-${{ matrix.os-name }}${{ matrix.executable }}

      - name: Copy Driver to Assets
        if: inputs.driver && inputs.core && matrix.os != 'windows-build-bot'
        run: |
          cp bazel-bin/driver/synnax-driver-v${{ needs.setup.outputs.VERSION }}-${{ matrix.os-name }}${{ matrix.executable }} core/pkg/service/driver/assets/driver${{ matrix.executable }}

      - name: Copy Driver to Assets (Windows)
        if: inputs.driver && inputs.core && matrix.os == 'windows-build-bot'
        shell: powershell
        run: |
          Copy-Item -Force bazel-bin/driver/synnax-driver-v${{ needs.setup.outputs.VERSION }}-${{ matrix.os-name }}.exe core/pkg/service/driver/assets/driver.exe

      - name: Set up pnpm
        if: inputs.console
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        if: inputs.console
        uses: actions/setup-node@v5
        with:
          node-version-file: package.json

      - name: Install Node Dependencies
        if: inputs.console
        run: pnpm install

      - name: Build Console Web Assets
        if: inputs.console
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: pnpm build:console-vite

      - name: Upload Console Assets as Artifact
        if: inputs.console
        uses: actions/upload-artifact@v4
        with:
          name:
            ${{ inputs.use_simple_artifact_names && format('synnax-console-assets-{0}',
            matrix.os-name) || format('synnax-console-assets-v{0}-{1}',
            needs.setup.outputs.VERSION, matrix.os-name) }}
          path: console/dist/
          retention-days: 7
          if-no-files-found: error

      - name: Copy Console to Assets
        if: inputs.console && inputs.core && matrix.os != 'windows-build-bot'
        run: cp -r console/dist/* core/pkg/service/console/dist/

      - name: Copy Console to Assets (Windows)
        if: inputs.console && inputs.core && matrix.os == 'windows-build-bot'
        shell: powershell
        run: |
          Copy-Item -Recurse -Force console/dist/* core/pkg/service/console/dist/

      - name: Set up Go
        if: inputs.core
        uses: actions/setup-go@v6
        with:
          go-version-file: go.work
          # Don't use github cache. Local cache is faster.
          cache: false

      - name: Build Core
        if: inputs.core
        working-directory: core
        shell: bash
        run: |
          go build ${{ needs.setup.outputs.GO_BUILD_TAGS }} \
            -ldflags="-w -s \
              -X github.com/synnaxlabs/synnax/pkg/version.Version=${{ needs.setup.outputs.VERSION }} \
              -X github.com/synnaxlabs/synnax/pkg/version.GitCommit=${{ github.sha }} \
              -X github.com/synnaxlabs/synnax/pkg/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o synnax-v${{ needs.setup.outputs.VERSION }}${{ matrix.executable }}

      - name: Sign macOS Server Binary
        if: inputs.sign_binaries && inputs.core && matrix.os == 'macos-build-bot'
        working-directory: core
        run: |
          cat > server-entitlements.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>com.apple.security.cs.allow-jit</key><true/>
            <key>com.apple.security.cs.allow-unsigned-executable-memory</key><true/>
          </dict>
          </plist>
          EOF

          CERT_INFO=$(security find-identity -v -p codesigning $KEYCHAIN_NAME | grep "Developer ID Application")
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          codesign --force --options runtime --timestamp \
            --entitlements server-entitlements.plist \
            --sign "$CERT_ID" ./synnax-v${{ needs.setup.outputs.VERSION }}
          codesign --verify --verbose ./synnax-v${{ needs.setup.outputs.VERSION }}

      - name: Notarize macOS Core Binary
        if: inputs.sign_binaries && inputs.core && matrix.os == 'macos-build-bot'
        working-directory: core
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create a zip for notarization (notarytool requires a container format)
          zip -j server-notarize.zip ./synnax-v${{ needs.setup.outputs.VERSION }}
          xcrun notarytool submit server-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          rm server-notarize.zip

      - name: Sign Windows Server Binary
        if: inputs.sign_binaries && inputs.core && matrix.os == 'windows-build-bot'
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          relic sign --file core/synnax-v${{ needs.setup.outputs.VERSION }}.exe --key azure --config relic.conf

      - name: Upload Core Binary as Artifact
        if: inputs.core
        uses: actions/upload-artifact@v4
        with:
          name:
            ${{ inputs.use_simple_artifact_names && format('synnax-core-{0}',
            matrix.os-name) || format('synnax-core-v{0}-{1}',
            needs.setup.outputs.VERSION, matrix.os-name) }}
          path: core/synnax-v${{ needs.setup.outputs.VERSION }}${{ matrix.executable }}
          retention-days: 7
          if-no-files-found: error

      - name: Rename Core Binary for Release
        if: inputs.core && inputs.upload_to_release
        working-directory: core
        run: |
          cp synnax-v${{ needs.setup.outputs.VERSION }}${{ matrix.executable }} synnax-v${{ needs.setup.outputs.VERSION }}-${{ matrix.os-name }}${{ matrix.executable }}

      - name: Upload Core to Release
        if: inputs.core && inputs.upload_to_release
        run: |
          gh release upload --clobber synnax-v${{ needs.setup.outputs.VERSION }} core/synnax-v${{ needs.setup.outputs.VERSION }}-${{ matrix.os-name }}${{ matrix.executable }}

      - name: Debug Build Environment
        if: failure() && matrix.os != 'windows-build-bot'
        run: integration/scripts/debug_build_environment_unix.sh

      - name: Debug Build Environment (Windows)
        if: failure() && matrix.os == 'windows-build-bot'
        shell: cmd
        run: integration/scripts/DebugBuildEnvironmentWindows.cmd

  docker:
    name: Build Docker Image
    needs: setup
    if: inputs.docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Update Submodules
        run: git submodule update --init --recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: inputs.upload_to_release
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and Push Docker Images
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./core/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ !inputs.upload_to_release && format('ghcr.io/synnaxlabs/synnax:{0}', github.sha) || '' }}
            ${{ inputs.upload_to_release && format('ghcr.io/synnaxlabs/synnax:{0}', needs.setup.outputs.VERSION) || '' }}
            ${{ inputs.upload_to_release && format('synnaxlabs/synnax:{0}', needs.setup.outputs.VERSION) || '' }}
            ${{ inputs.upload_to_release && github.ref == 'refs/heads/main' && 'ghcr.io/synnaxlabs/synnax:latest' || '' }}
            ${{ inputs.upload_to_release && github.ref == 'refs/heads/main' && 'synnaxlabs/synnax:latest' || '' }}
            ${{ inputs.upload_to_release && github.ref == 'refs/heads/rc' && 'ghcr.io/synnaxlabs/synnax:rc' || '' }}
            ${{ inputs.upload_to_release && github.ref == 'refs/heads/rc' && 'synnaxlabs/synnax:rc' || '' }}
          cache-from: type=gha,scope=synnax-docker-cache
          cache-to: type=gha,mode=min,scope=synnax-docker-cache
          sbom: ${{ inputs.upload_to_release }}
          provenance: ${{ inputs.upload_to_release && 'mode=max' || 'false' }}
          build-args: |
            DRIVER_ENABLED=${{ inputs.driver }}
            CONSOLE_ENABLED=${{ inputs.console }}
            VERSION=${{ needs.setup.outputs.VERSION }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.repository.updated_at }}

  build-console-tauri:
    name: Build Console App
    needs: [setup]
    if: inputs.console_tauri && needs.setup.outputs.console_tauri_matrix != '[]'
    permissions:
      contents: write
    env:
      SYNNAX_TS_ENV: prod
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_OPTIONS: "--max_old_space_size=4096"
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJSON(needs.setup.outputs.console_tauri_matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Import Apple Developer Certificate
        if: matrix.os == 'macos-latest' && inputs.sign_binaries
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: build-${{ github.run_id }}.keychain
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security delete-keychain $KEYCHAIN_NAME 2>/dev/null || true
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_NAME
          security list-keychains -d user -s $KEYCHAIN_NAME $(security list-keychains -d user | tr -d '"')
          security default-keychain -s $KEYCHAIN_NAME
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_NAME
          security set-keychain-settings -t 3600 -u $KEYCHAIN_NAME
          security import certificate.p12 -k $KEYCHAIN_NAME -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_NAME
          security find-identity -v -p codesigning $KEYCHAIN_NAME
          echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> $GITHUB_ENV

      - name: Verify Apple Developer Certificate
        if: matrix.os == 'macos-latest' && inputs.sign_binaries
        run: |
          CERT_INFO=$(security find-identity -v -p codesigning $KEYCHAIN_NAME | grep "Developer ID Application")
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          echo "CERT_ID=$CERT_ID" >> $GITHUB_ENV
          echo "Certificate imported."

      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Get Console Version
        id: console-version
        working-directory: console
        shell: bash
        run: |
          CONSOLE_VERSION=$(node -p "require('./package.json').version")
          echo "CONSOLE_VERSION=${CONSOLE_VERSION}" >> $GITHUB_OUTPUT
          if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
            echo "VERSION=${CONSOLE_VERSION}" >> $GITHUB_OUTPUT
          elif [ "${GITHUB_REF}" == "refs/heads/rc" ]; then
            echo "VERSION=${CONSOLE_VERSION}-rc" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${CONSOLE_VERSION}-pr" >> $GITHUB_OUTPUT
          fi

      - name: Set up pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: package.json
          cache: pnpm

      - name: Adjust Auto Updater URL for Release Candidate
        if: inputs.sign_binaries && github.ref == 'refs/heads/rc'
        working-directory: console/src-tauri
        run: |
          jq '.plugins.updater.endpoints = ["https://raw.githubusercontent.com/synnaxlabs/synnax/rc/console/release-spec.json"]' tauri.conf.json > temp.json
          rm tauri.conf.json
          mv temp.json tauri.conf.json

      - name: Install Rust
        run: rustup update

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: console/src-tauri -> target
          shared-key: ${{ runner.os }}

      - name: Install Dependencies
        run: pnpm install

      - name: Build TypeScript
        run: pnpm build:console-vite

      - name: Pre-sign Embedded lua-language-server
        if: matrix.os == 'macos-latest' && inputs.sign_binaries
        env:
          APPLE_SIGNING_IDENTITY: ${{ env.CERT_ID }}
        run: |
          EMBEDDED_BIN_REPO="vendor/lua-language-server/bin/macOS/lua-language-server"
          if [ ! -f "$EMBEDDED_BIN_REPO" ]; then
            echo "Embedded binary not found at $EMBEDDED_BIN_REPO"
            exit 1
          fi
          echo "Pre-signing embedded binary at $EMBEDDED_BIN_REPO..."
          codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$EMBEDDED_BIN_REPO"
          codesign --verify --verbose "$EMBEDDED_BIN_REPO"

      - name: Download relic for Windows signing
        if: matrix.os == 'windows-latest' && inputs.sign_binaries
        shell: bash
        run: |
          curl -L -o relic.exe https://github.com/sassoftware/relic/releases/latest/download/relic-windows-amd64.exe

      - name: Add relic to PATH
        if: matrix.os == 'windows-latest' && inputs.sign_binaries
        run: |
          mkdir relic-bin
          mv relic.exe relic-bin\
          echo "${{ github.workspace }}\relic-bin" >> $env:GITHUB_PATH

      - name: Build Console Tauri (Signed)
        if: inputs.sign_binaries
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.CERT_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        working-directory: console
        run: pnpm build

      - name: Build Console Tauri (Unsigned)
        if: ${{ !inputs.sign_binaries }}
        env:
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        working-directory: console
        run: pnpm build

      - name: Upload Console App as Artifact
        uses: actions/upload-artifact@v4
        with:
          name:
            ${{ matrix.os == 'macos-latest' && 'synnax-console-macos' ||
            'synnax-console-windows' }}
          path: |
            ${{ matrix.os == 'macos-latest' && format('console/src-tauri/target/release/bundle/dmg/Synnax_{0}_aarch64.dmg', steps.console-version.outputs.CONSOLE_VERSION) || '' }}
            ${{ matrix.os == 'windows-latest' && format('console/src-tauri/target/release/bundle/msi/Synnax_{0}_x64_en-US.msi', steps.console-version.outputs.CONSOLE_VERSION) || '' }}
            ${{ matrix.os == 'windows-latest' && format('console/src-tauri/target/release/bundle/nsis/Synnax_{0}_x64-setup.exe', steps.console-version.outputs.CONSOLE_VERSION) || '' }}
          retention-days: 7
          if-no-files-found: error

      - name: Upload macOS Release Assets
        if: inputs.upload_to_release && matrix.os == 'macos-latest'
        run: |
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/macos/Synnax.app.tar.gz
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/macos/Synnax.app.tar.gz.sig
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/dmg/Synnax_${{ steps.console-version.outputs.CONSOLE_VERSION }}_aarch64.dmg

      - name: Upload Windows Release Assets
        if: inputs.upload_to_release && matrix.os == 'windows-latest'
        run: |
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/msi/Synnax_${{ steps.console-version.outputs.CONSOLE_VERSION }}_x64_en-US.msi
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/msi/Synnax_${{ steps.console-version.outputs.CONSOLE_VERSION }}_x64_en-US.msi.sig
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/nsis/Synnax_${{ steps.console-version.outputs.CONSOLE_VERSION }}_x64-setup.exe
          gh release upload --clobber console-v${{ steps.console-version.outputs.VERSION }} ./console/src-tauri/target/release/bundle/nsis/Synnax_${{ steps.console-version.outputs.CONSOLE_VERSION }}_x64-setup.exe.sig

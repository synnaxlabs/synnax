name: CPP Linter
on:
  push:
    branches:
      - main
      - rc
      - sy-2071-add-linter-in-ci
    paths:
      - 'driver/**/*.cpp'
      - 'driver/**/*.cc'
      - 'driver/**/*.h'
      - 'driver/**/*.hpp'
      - 'client/cpp/**/*.cpp'
      - 'client/cpp/**/*.cc'
      - 'client/cpp/**/*.h'
      - 'client/cpp/**/*.hpp'
      - '.github/workflows/test.cpp-linter.yaml'
  pull_request:
    branches:
      - main
      - rc
      - sy-2071-add-linter-in-ci
    paths:
      - 'driver/**/*.cpp'
      - 'driver/**/*.cc'
      - 'driver/**/*.h'
      - 'driver/**/*.hpp'
      - 'client/cpp/**/*.cpp'
      - 'client/cpp/**/*.cc'
      - 'client/cpp/**/*.h'
      - 'client/cpp/**/*.hpp'
      - '.github/workflows/cpp-linter.yaml'
  workflow_dispatch:

jobs:
  cpp-lint:
    name: cpp-lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Dependencies first
      - name: Install Deps On Ubuntu
        run: |
          sudo apt-get install -y libmbedtls-dev libsystemd-dev

      # Cache Open62541 Build
      - name: Cache Open62541 Build
        id: cache-open62541
        uses: actions/cache@v3
        with:
          path: driver/vendor/open62541/open62541/out
          key: open62541-ubuntu-latest

      # Update Submodules
      - name: Update Submodules
        if: hashFiles('driver/vendor/open62541/open62541/out') == ''
        run: git submodule update --init --recursive

      # Build Open62541
      - name: Build Open62541
        if: hashFiles('driver/vendor/open62541/open62541/out') == ''
        shell: bash
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo \
               -DUA_NAMESPACE_ZERO=FULL \
               -DCMAKE_INSTALL_PREFIX=../out \
               -DUA_ENABLE_ENCRYPTION=MBEDTLS ..
          cmake --build . --config RelWithDebInfo --target install
        working-directory: driver/vendor/open62541/open62541

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.1
        with:
          bazelisk-cache: true
          repository-cache: true

      # Generate compile_commands.json
      - name: Generate compile_commands.json
        run: |
          bazel run @hedron_compile_commands//:refresh_all
      
      - name: Debug Compilation Database
        run: |
          ls -la compile_commands.json
          echo "First few lines of compile_commands.json:"
          head -n 20 compile_commands.json
      
      - name: Debug clang-tidy command
        run: |
          echo "CLANG_TIDY_COMMAND=${{ steps.linter-driver.outputs.clang-tidy-command }}"
          clang-tidy --version
          ls -la .clang-tidy
          cat .clang-tidy
      
      - name: Verify clang-tidy directly
        run: |
          clang-tidy driver/ni/analog_read.cpp -p compile_commands.json || true
          echo "Exit code: $?"

      - name: Run CPP Linter for Driver
        uses: cpp-linter/cpp-linter-action@v2
        id: linter-driver
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          style: '' #'file'  # Use .clang-format file
          tidy-checks: '' # Use .clang-tidy file
          version: 16
          files-changed-only: false 
          lines-changed-only: false
          ignore: |
            vendor/
            external/
            third_party/
            .*pb\\.h$
            .*pb\\.cc$
            driver/vendor/
            driver/scripts/
            driver/test/
          database: 'compile_commands.json'
          extra-args: '-Wno-unknown-warning-option --warnings-as-errors=*'
          thread-comments: ${{ github.event_name == 'pull_request' }}
          step-summary: true
          verbosity: 2
          directories: |
            driver

      - name: Run CPP Linter for Client
        uses: cpp-linter/cpp-linter-action@v2
        id: linter-client
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          style: '' #'file'  # Use .clang-format file
          tidy-checks: '' # Use .clang-tidy file
          version: 16
          files-changed-only: false 
          lines-changed-only: false
          ignore: 'vendor/|external/|third_party/|.*pb\\.h$|.*pb\\.cc$'
          database: 'compile_commands.json'
          extra-args: -Wno-unknown-warning-option
          thread-comments: ${{ github.event_name == 'pull_request' }}
          step-summary: true
          directories: |
            client/cpp

      - name: Fail if checks failed
        if: steps.linter-driver.outputs.checks-failed > 0 || steps.linter-client.outputs.checks-failed > 0
        run: |
          echo "Linting checks failed!"
          echo "Driver checks failed: ${{ steps.linter-driver.outputs.checks-failed }}"
          echo "Client checks failed: ${{ steps.linter-client.outputs.checks-failed }}"
          exit 1
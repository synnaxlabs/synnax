name: Deploy - Python

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/deploy.py.yaml
      - alamos/py/**
      - freighter/py/**
      - client/py/**
      - pyproject.toml
      - uv.lock
      - uv.toml
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    env:
      UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: client/py/pyproject.toml

      - name: Diff Changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.ref }}
          filters: |
            shared: &shared
              - .github/workflows/deploy.py.yaml
              - pyproject.toml
              - uv.lock
              - uv.toml
            alamos: &alamos
              - *shared
              - alamos/py/**
            freighter: &freighter
              - *shared
              - *alamos
              - freighter/py/**
            client:
              - *shared
              - *freighter
              - client/py/**

      - name: Publish Alamos
        if: steps.filter.outputs.alamos == 'true'
        working-directory: alamos/py
        run: |
          uv build && uv publish

      - name: Publish Freighter
        if: steps.filter.outputs.freighter == 'true'
        working-directory: freighter/py
        run: |
          for i in {1..10}; do
            uv build --no-sources && break
            echo "Waiting for dependencies on PyPI (attempt $i/10)..."
            sleep 5
          done
          uv publish

      - name: Publish Client
        if: steps.filter.outputs.client == 'true'
        working-directory: client/py
        run: |
          for i in {1..10}; do
            uv build --no-sources && break
            echo "Waiting for dependencies on PyPI (attempt $i/10)..."
            sleep 5
          done
          uv publish

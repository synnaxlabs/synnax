// Copyright 2026 Synnax Labs, Inc.
//
// Use of this software is governed by the Business Source License included in the file
// licenses/BSL.txt.
//
// As of the Change Date specified in that file, in accordance with the Business Source
// License, use of this software will be governed by the Apache License, Version 2.0,
// included in the file licenses/APL.txt.

package cmd

import (
	"io"
	"os"
	"strings"

	"github.com/samber/lo"
	"github.com/spf13/cobra"
	"github.com/spf13/viper"
	"github.com/synnaxlabs/synnax/cmd/cert"
	"github.com/synnaxlabs/synnax/cmd/service"
	"github.com/synnaxlabs/synnax/cmd/start"
	"github.com/synnaxlabs/synnax/cmd/version"
	"go.uber.org/zap"
)

var cmd = &cobra.Command{
	Use:   "synnax",
	Short: "The telemetry engine for operating large scale hardware systems with ease",
	Long:  "Synnax is a distributed telemetry engine designed to acquire and store data from, issue commands to, and process telemetry generated by hardware systems. It scales horizontally, and can be deployed on edge devices (data acquisition) in highly dynamic environments with intermittent network connectivity, or in cloud environments (data processing) for high performance analysis.",
	RunE: func(cmd *cobra.Command, _ []string) error {
		cmd.SilenceUsage = true
		if viper.GetBool(flagVersion) {
			return version.FPrint(cmd.OutOrStdout())
		}
		return cmd.Help()
	},
}

// Execute is the entrypoint for the CLI.
func Execute() {
	if err := cmd.Execute(); err != nil {
		os.Exit(1)
	}
}

// ExecuteWithArgs runs the CLI with the given arguments and writes output to out. This
// is useful for testing.
func ExecuteWithArgs(args []string, out io.Writer) error {
	cmd.SetArgs(args)
	cmd.SetOut(out)
	cmd.SetErr(out)
	return cmd.Execute()
}

func init() {
	bindFlags(cmd)
	lo.Must0(viper.BindPFlags(cmd.Flags()))
	lo.Must0(service.AddCommand(cmd))
	version.AddCommand(cmd)
	lo.Must0(start.AddCommand(cmd))
	lo.Must0(cert.AddCommand(cmd))
	cobra.OnInitialize(initConfig)
}

func initConfig() {
	cfgFile := viper.GetString(start.FlagConfig)
	if cfgFile != "" {
		viper.SetConfigFile(cfgFile)
	} else {
		home, err := os.UserHomeDir()
		cobra.CheckErr(err)
		viper.AddConfigPath(home)
		viper.SetConfigType("yaml")
		viper.SetConfigName(".synnax")
	}
	viper.SetEnvPrefix("synnax")
	viper.AutomaticEnv()
	viper.SetEnvKeyReplacer(strings.NewReplacer("-", "_"))
	if err := viper.ReadInConfig(); err != nil {
		zap.S().Error("failed to read config", zap.Error(err))
	}
}

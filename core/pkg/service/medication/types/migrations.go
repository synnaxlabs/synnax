// Code generated by jerky. DO NOT EDIT.

package types

import (
	"github.com/synnaxlabs/synnax/pkg/service/medication"
	"github.com/synnaxlabs/x/jerky/migrate"
	"github.com/vmihailenco/msgpack/v5"
	"google.golang.org/protobuf/proto"
)

// Migrations is the migration registry for Medication.
var Migrations = migrate.Registry{
	TypeName:       "Medication",
	CurrentVersion: 1,
	Migrations: []migrate.Migration{
		{
			FromVersion: 0,
			ToVersion:   1,
			Migrate:     migrateMedicationV0ToV1,
		},
	},
}

// UnmarshalMedicationWithMigration deserializes bytes into the current version,
// handling migrations from older versions if needed.
func UnmarshalMedicationWithMigration(data []byte) (*Medication, error) {
	// Fast path: try current version first
	var current MedicationV1
	if err := proto.Unmarshal(data, &current); err == nil {
		return &current, nil
	}

	// Bootstrap: try msgpack (pre-jerky format)
	return unmarshalMedicationBootstrap(data)
}

// unmarshalMedicationBootstrap handles pre-jerky msgpack data.
func unmarshalMedicationBootstrap(data []byte) (*Medication, error) {
	var legacy medication.Medication
	if err := msgpack.Unmarshal(data, &legacy); err != nil {
		return nil, err
	}
	pb := TranslateMedicationForward(legacy)
	return pb, nil
}

// migrateMedicationV0ToV1 is the bootstrap migration from msgpack.
func migrateMedicationV0ToV1(data []byte) ([]byte, error) {
	// Try proto first (already migrated)
	var v1 MedicationV1
	if err := proto.Unmarshal(data, &v1); err == nil {
		return data, nil
	}

	// Decode legacy msgpack
	var legacy medication.Medication
	if err := msgpack.Unmarshal(data, &legacy); err != nil {
		return nil, err
	}

	// Translate and marshal as proto
	pb := TranslateMedicationV1Forward(legacy)
	return proto.Marshal(pb)
}

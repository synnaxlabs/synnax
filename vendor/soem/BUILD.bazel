###############################################################################
# SOEM BUILD Configuration
#
# This builds SOEM (Simple Open EtherCAT Master) from source for Linux, macOS,
# and Windows. Platform-specific OSAL and OSHW layers are selected via Bazel.
###############################################################################

# Core SOEM sources (platform-independent)
SOEM_CORE_SRCS = [
    "SOEM/src/ec_base.c",
    "SOEM/src/ec_coe.c",
    "SOEM/src/ec_config.c",
    "SOEM/src/ec_dc.c",
    "SOEM/src/ec_eoe.c",
    "SOEM/src/ec_foe.c",
    "SOEM/src/ec_main.c",
    "SOEM/src/ec_print.c",
    "SOEM/src/ec_soe.c",
]

# Core SOEM headers
SOEM_HDRS = glob(["SOEM/include/soem/*.h"])

# Linux OSAL + OSHW
LINUX_OSAL_SRCS = ["SOEM/osal/linux/osal.c"]
LINUX_OSHW_SRCS = [
    "SOEM/oshw/linux/nicdrv.c",
    "SOEM/oshw/linux/oshw.c",
]
LINUX_PLATFORM_HDRS = [
    "SOEM/osal/linux/osal_defs.h",
    "SOEM/oshw/linux/nicdrv.h",
    "SOEM/oshw/linux/oshw.h",
]

# macOS OSAL + OSHW (uses pcap) - custom platform files outside submodule
MACOS_OSAL_SRCS = ["macos/osal/osal.c"]
MACOS_OSHW_SRCS = [
    "macos/oshw/nicdrv.c",
    "macos/oshw/oshw.c",
]
MACOS_PLATFORM_HDRS = [
    "macos/osal/osal_defs.h",
    "macos/oshw/nicdrv.h",
    "macos/oshw/oshw.h",
]

# Windows OSAL + OSHW
WIN32_OSAL_SRCS = ["SOEM/osal/win32/osal.c"]
WIN32_OSHW_SRCS = [
    "SOEM/oshw/win32/nicdrv.c",
    "SOEM/oshw/win32/oshw.c",
]
WIN32_PLATFORM_HDRS = [
    "SOEM/osal/win32/osal_defs.h",
    "SOEM/oshw/win32/nicdrv.h",
    "SOEM/oshw/win32/oshw.h",
] + glob(["SOEM/oshw/win32/wpcap/Include/**/*.h"])

# Generate ec_options.h with complete configuration
genrule(
    name = "generate_ec_options_h",
    outs = ["soem/ec_options.h"],
    cmd = """
cat > $@ << 'EOF'
/*
 * SOEM build options - generated by Bazel
 */

#ifndef _ec_options_
#define _ec_options_

#ifdef __cplusplus
extern "C" {
#endif

/* Max sizes */

/** standard frame buffer size in bytes */
#define EC_BUFSIZE 1518

/** number of frame buffers per channel (tx, rx1 rx2) */
#define EC_MAXBUF 16

/** size of EEPROM bitmap cache */
#define EC_MAXEEPBITMAP 128

/** size of EEPROM cache buffer */
#define EC_MAXEEPBUF 10000

/** default group size in 2^x */
#define EC_LOGGROUPOFFSET 16

/** max. entries in EtherCAT error list */
#define EC_MAXELIST 64

/** max. length of readable name in slavelist and Object Description List */
#define EC_MAXNAME 40

/** max. number of slaves in array */
#define EC_MAXSLAVE 200

/** max. number of groups */
#define EC_MAXGROUP 2

/** max. number of IO segments per group */
#define EC_MAXIOSEGMENTS 64

/** max. mailbox size */
#define EC_MAXMBX 1486

/** number of mailboxes in pool */
#define EC_MBXPOOLSIZE 64

/** max. eeprom PDO entries */
#define EC_MAXEEPDO 512

/** max. SM used */
#define EC_MAXSM 8

/** max. FMMU used */
#define EC_MAXFMMU 4

/** max. adapter name length */
#define EC_MAXLEN_ADAPTERNAME 128

/** define maximum number of concurrent threads in mapping */
#define EC_MAX_MAPT 1

/** max entries in Object Description list */
#define EC_MAXODLIST 1024

/** max entries in Object Entry list */
#define EC_MAXOELIST 256

/** max. length of readable SoE name */
#define EC_SOE_MAXNAME 40

/** max. number of SoE mappings */
#define EC_SOE_MAXMAPPING 64

/* Timeouts and retries */

/** timeout value in us for tx frame to return to rx */
#define EC_TIMEOUTRET 2000

/** timeout value in us for safe data transfer, max. triple retry */
#define EC_TIMEOUTRET3 2000

/** timeout value in us for return "safe" variant (f.e. wireless) */
#define EC_TIMEOUTSAFE 20000

/** timeout value in us for EEPROM access */
#define EC_TIMEOUTEEP 20000

/** timeout value in us for tx mailbox cycle */
#define EC_TIMEOUTTXM 20000

/** timeout value in us for rx mailbox cycle */
#define EC_TIMEOUTRXM 700000

/** timeout value in us for check statechange */
#define EC_TIMEOUTSTATE 2000000

/** default number of retries if wkc <= 0 */
#define EC_DEFAULTRETRIES 3

/* MAC addresses */

/** Primary source MAC address used for EtherCAT. */
#define EC_PRIMARY_MAC_ARRAY { 0x02, 0x00, 0x00, 0x00, 0x00, 0x01 }

/** Secondary source MAC address used for EtherCAT. */
#define EC_SECONDARY_MAC_ARRAY { 0x02, 0x00, 0x00, 0x00, 0x00, 0x02 }

#ifdef __cplusplus
}
#endif

#endif
EOF""",
)

cc_library(
    name = "soem",
    srcs = SOEM_CORE_SRCS + select({
        "@platforms//os:linux": LINUX_OSAL_SRCS + LINUX_OSHW_SRCS,
        "@platforms//os:macos": MACOS_OSAL_SRCS + MACOS_OSHW_SRCS,
        "@platforms//os:windows": WIN32_OSAL_SRCS + WIN32_OSHW_SRCS,
    }),
    hdrs = SOEM_HDRS + [
        "SOEM/osal/osal.h",
        ":generate_ec_options_h",
    ] + select({
        "@platforms//os:linux": LINUX_PLATFORM_HDRS,
        "@platforms//os:macos": MACOS_PLATFORM_HDRS,
        "@platforms//os:windows": WIN32_PLATFORM_HDRS,
    }),
    copts = select({
        "@platforms//os:windows": [
            "/D_CRT_SECURE_NO_WARNINGS",
            "/DWIN32",
        ],
        "//conditions:default": [
            "-Wno-unused-parameter",
            "-Wno-sign-compare",
        ],
    }),
    includes = [
        ".",
        "SOEM/include",
        "SOEM/osal",
    ] + select({
        "@platforms//os:linux": [
            "SOEM/osal/linux",
            "SOEM/oshw/linux",
        ],
        "@platforms//os:macos": [
            "macos/osal",
            "macos/oshw",
        ],
        "@platforms//os:windows": [
            "SOEM/osal/win32",
            "SOEM/oshw/win32",
            "SOEM/oshw/win32/wpcap/Include",
        ],
    }),
    linkopts = select({
        "@platforms//os:linux": ["-lpthread"],
        "@platforms//os:macos": ["-lpthread", "-lpcap"],
        "@platforms//os:windows": [
            "Packet.lib",
            "wpcap.lib",
            "Ws2_32.lib",
            "winmm.lib",
        ],
    }),
    visibility = ["//visibility:public"],
)

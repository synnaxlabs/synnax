# Create Windows config.h header
genrule(
    name = "generate_config_h",
    outs = ["config.h"],
    cmd = """
cat > $@ << 'EOF'
#ifndef CONFIG_H
#define CONFIG_H

/* Windows MSVC Configuration */
#define PACKAGE_NAME "libmodbus"
#define PACKAGE_VERSION "3.1.10"
#define VERSION "3.1.10"

/* Standard C headers available in MSVC */
#define HAVE_ERRNO_H 1
#define HAVE_FCNTL_H 1
#define HAVE_INTTYPES_H 1
#define HAVE_LIMITS_H 1
#define HAVE_STDINT_H 1
#define HAVE_STDIO_H 1
#define HAVE_STDLIB_H 1
#define HAVE_STRING_H 1
#define HAVE_SYS_STAT_H 1
#define HAVE_SYS_TYPES_H 1
#define HAVE_TIME_H 1
#define HAVE_UNISTD_H 1
#define HAVE_WCHAR_H 1

/* Windows socket functions */
#define HAVE_SELECT 1
#define HAVE_SOCKET 1
#define HAVE_INET_NTOP 1
#define HAVE_INET_PTON 1

/* Windows doesn't have these Unix-specific features */
#define HAVE_DECL_TIOCSRS485 0
#define HAVE_DECL_TIOCM_RTS 0

/* Define for Windows */
#define _WIN32_WINNT 0x0600

#endif
EOF""",
)

# Create modbus-version.h header
genrule(
    name = "generate_version_h",
    outs = ["modbus/modbus-version.h"],
    cmd = """
cat > $@ << 'EOF'
#ifndef MODBUS_VERSION_H
#define MODBUS_VERSION_H
#define LIBMODBUS_VERSION_MAJOR 3
#define LIBMODBUS_VERSION_MINOR 1
#define LIBMODBUS_VERSION_MICRO 10
#define LIBMODBUS_VERSION_STRING "3.1.10"
#endif
EOF""",
)

# Copy and modify ALL headers and sources for static linking
genrule(
    name = "prepare_static_sources",
    srcs = [
        "libmodbus/src/modbus.h",
        "libmodbus/src/modbus-tcp.h", 
        "libmodbus/src/modbus-rtu.h",
        "libmodbus/src/modbus-private.h",
        "libmodbus/src/modbus-tcp-private.h",
        "libmodbus/src/modbus-rtu-private.h",
        "libmodbus/src/modbus.c",
        "libmodbus/src/modbus-data.c",
        "libmodbus/src/modbus-rtu.c",
        "libmodbus/src/modbus-tcp.c",
    ],
    outs = [
        "modbus/modbus.h",
        "modbus/modbus-tcp.h",
        "modbus/modbus-rtu.h",
        "modbus-private.h",
        "modbus-tcp-private.h",
        "modbus-rtu-private.h",
        "src/modbus.c",
        "src/modbus-data.c",
        "src/modbus-rtu.c",
        "src/modbus-tcp.c",
    ],
    cmd = select({
        "@platforms//os:windows": """
# First, copy and fix modbus.h header
cp $(location libmodbus/src/modbus.h) $(@D)/modbus/modbus.h.tmp
# Use Python to replace the MODBUS_API definitions and fix stdint.h
python -c "
import re
with open('$(@D)/modbus/modbus.h.tmp', 'r') as f:
    content = f.read()
# Replace the entire _MSC_VER block with a simple MODBUS_API definition
pattern = r'#if defined\\(_MSC_VER\\)[\\s\\S]*?#else[\\s\\S]*?#endif'
replacement = '#define MODBUS_API'
content = re.sub(pattern, replacement, content)
# Fix stdint.h include for Windows
content = content.replace('#include \"stdint.h\"', '#include <stdint.h>')
with open('$(@D)/modbus/modbus.h', 'w') as f:
    f.write(content)
"

# Copy other headers as-is
cp $(location libmodbus/src/modbus-tcp.h) $(@D)/modbus/modbus-tcp.h 
cp $(location libmodbus/src/modbus-rtu.h) $(@D)/modbus/modbus-rtu.h
# Fix private headers to use correct modbus.h path
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-private.h) > $(@D)/modbus-private.h
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-tcp-private.h) > $(@D)/modbus-tcp-private.h
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-rtu-private.h) > $(@D)/modbus-rtu-private.h

# Copy source files and fix their includes to use our fixed headers
sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus.c) > $(@D)/src/modbus.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus.c

sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus-data.c) > $(@D)/src/modbus-data.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus-data.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus-data.c

sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus-rtu.c) > $(@D)/src/modbus-rtu.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus-rtu.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus-rtu.c

sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus-tcp.c) > $(@D)/src/modbus-tcp.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus-tcp.c  
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus-tcp.c
""",
        "//conditions:default": """
# Unix/Mac - just copy headers as-is, use standard autotools build
cp $(location libmodbus/src/modbus.h) $(@D)/modbus/modbus.h
cp $(location libmodbus/src/modbus-tcp.h) $(@D)/modbus/modbus-tcp.h 
cp $(location libmodbus/src/modbus-rtu.h) $(@D)/modbus/modbus-rtu.h
cp $(location libmodbus/src/modbus-private.h) $(@D)/modbus-private.h
cp $(location libmodbus/src/modbus-tcp-private.h) $(@D)/modbus-tcp-private.h
cp $(location libmodbus/src/modbus-rtu-private.h) $(@D)/modbus-rtu-private.h
# Sources aren't used on Unix, but copy for consistency
cp $(location libmodbus/src/modbus.c) $(@D)/src/modbus.c
cp $(location libmodbus/src/modbus-data.c) $(@D)/src/modbus-data.c
cp $(location libmodbus/src/modbus-rtu.c) $(@D)/src/modbus-rtu.c
cp $(location libmodbus/src/modbus-tcp.c) $(@D)/src/modbus-tcp.c
""",
    }),
)

# Generate config.h for Unix
genrule(
    name = "generate_unix_config_h",
    outs = ["unix/config.h"],
    cmd = """
cat > $@ << 'EOF'
#ifndef LIBMODBUS_CONFIG_H
#define LIBMODBUS_CONFIG_H

#define PACKAGE_NAME "libmodbus"
#define PACKAGE_VERSION "3.1.11"
#define VERSION "3.1.11"

#define HAVE_ARPA_INET_H 1
#define HAVE_ERRNO_H 1
#define HAVE_FCNTL_H 1
#define HAVE_LIMITS_H 1
#define HAVE_NETDB_H 1
#define HAVE_NETINET_IN_H 1
#define HAVE_NETINET_TCP_H 1
#define HAVE_SYS_IOCTL_H 1
#define HAVE_SYS_SOCKET_H 1
#define HAVE_SYS_TIME_H 1
#define HAVE_SYS_TYPES_H 1
#define HAVE_TERMIOS_H 1
#define HAVE_TIME_H 1
#define HAVE_UNISTD_H 1
#define HAVE_STDINT_H 1
#define HAVE_INTTYPES_H 1

#define HAVE_GETADDRINFO 1
#define HAVE_GETTIMEOFDAY 1
#define HAVE_INET_NTOP 1
#define HAVE_INET_PTON 1
#define HAVE_SELECT 1
#define HAVE_SOCKET 1
#define HAVE_STRERROR 1
#define HAVE_STRLCPY 1

#define HAVE_DECL_TIOCM_RTS 1
#define HAVE_DECL_TIOCSRS485 0

#endif
EOF""",
)

# Generate modbus-version.h for Unix
genrule(
    name = "generate_unix_version_h",
    outs = ["unix/modbus-version.h"],
    cmd = """
cat > $@ << 'EOF'
#ifndef MODBUS_VERSION_H
#define MODBUS_VERSION_H
#define LIBMODBUS_VERSION_MAJOR 3
#define LIBMODBUS_VERSION_MINOR 1
#define LIBMODBUS_VERSION_MICRO 11
#define LIBMODBUS_VERSION_STRING "3.1.11"
#endif
EOF""",
)

# Copy and modify headers for Unix (matching Windows layout)
genrule(
    name = "prepare_unix_headers",
    srcs = [
        "libmodbus/src/modbus.h",
        "libmodbus/src/modbus-tcp.h",
        "libmodbus/src/modbus-rtu.h",
        "libmodbus/src/modbus-private.h",
        "libmodbus/src/modbus-tcp-private.h",
        "libmodbus/src/modbus-rtu-private.h",
    ],
    outs = [
        "unix_hdrs/modbus/modbus.h",
        "unix_hdrs/modbus/modbus-tcp.h",
        "unix_hdrs/modbus/modbus-rtu.h",
        "unix_hdrs/modbus-private.h",
        "unix_hdrs/modbus-tcp-private.h",
        "unix_hdrs/modbus-rtu-private.h",
    ],
    cmd = """
# Copy public headers to modbus/ directory
cp $(location libmodbus/src/modbus.h) $(location unix_hdrs/modbus/modbus.h)
cp $(location libmodbus/src/modbus-tcp.h) $(location unix_hdrs/modbus/modbus-tcp.h)
cp $(location libmodbus/src/modbus-rtu.h) $(location unix_hdrs/modbus/modbus-rtu.h)

# Fix private headers to use modbus/modbus.h path
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-private.h) > $(location unix_hdrs/modbus-private.h)
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-tcp-private.h) > $(location unix_hdrs/modbus-tcp-private.h)
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-rtu-private.h) > $(location unix_hdrs/modbus-rtu-private.h)
""",
)

# Modify source files to use correct include paths
genrule(
    name = "prepare_unix_sources",
    srcs = [
        "libmodbus/src/modbus.c",
        "libmodbus/src/modbus-data.c",
        "libmodbus/src/modbus-rtu.c",
        "libmodbus/src/modbus-tcp.c",
    ],
    outs = [
        "unix_src/modbus.c",
        "unix_src/modbus-data.c",
        "unix_src/modbus-rtu.c",
        "unix_src/modbus-tcp.c",
    ],
    cmd = """
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus.c) > $(location unix_src/modbus.c)
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus-data.c) > $(location unix_src/modbus-data.c)
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus-rtu.c) > $(location unix_src/modbus-rtu.c)
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus-tcp.c) > $(location unix_src/modbus-tcp.c)
""",
)

# Compile libmodbus directly on Unix/Mac without autotools to avoid sandbox timestamp issues
cc_library(
    name = "libmodbus_unix",
    srcs = [
        ":prepare_unix_sources",
        ":generate_unix_config_h",
        ":generate_unix_version_h",
    ],
    hdrs = [
        ":prepare_unix_headers",
        ":generate_unix_version_h",
    ],
    copts = [
        "-DHAVE_ARPA_INET_H",
        "-DHAVE_ERRNO_H",
        "-DHAVE_FCNTL_H",
        "-DHAVE_LIMITS_H",
        "-DHAVE_NETDB_H",
        "-DHAVE_NETINET_IN_H",
        "-DHAVE_NETINET_TCP_H",
        "-DHAVE_SYS_IOCTL_H",
        "-DHAVE_SYS_SOCKET_H",
        "-DHAVE_SYS_TIME_H",
        "-DHAVE_SYS_TYPES_H",
        "-DHAVE_TERMIOS_H",
        "-DHAVE_TIME_H",
        "-DHAVE_UNISTD_H",
        "-DHAVE_STDINT_H",
        "-DHAVE_INTTYPES_H",
        "-DHAVE_GETADDRINFO",
        "-DHAVE_GETTIMEOFDAY",
        "-DHAVE_INET_NTOP",
        "-DHAVE_INET_PTON",
        "-DHAVE_SELECT",
        "-DHAVE_SOCKET",
        "-DHAVE_STRERROR",
        "-DHAVE_STRLCPY",
        "-DHAVE_DECL_TIOCM_RTS=1",
        "-DHAVE_DECL_TIOCSRS485=0",
        "-DIPTOS_LOWDELAY=0x10",  # Define IP TOS constant for low delay
    ],
    includes = [
        "unix_hdrs",  # Allows modbus/modbus.h and modified private headers to be found
        "libmodbus/src",  # For source files' local #include "modbus.h"
        "unix",  # For generated config.h
    ],
    visibility = ["//visibility:public"],
)

cc_library(
    name = "libmodbus",
    srcs = select({
        "@platforms//os:windows": [
            ":prepare_static_sources",
            ":generate_config_h",
        ],
        "//conditions:default": [],
    }),
    hdrs = select({
        "@platforms//os:windows": [
            ":prepare_static_sources",
            ":generate_version_h",
        ],
        "//conditions:default": [],
    }),
    copts = select({
        "@platforms//os:windows": [
            "/DHAVE_CONFIG_H",
            "/D_WIN32_WINNT=0x0600",
            "/DMODBUS_API=",  # Override MODBUS_API for static linking
            "/I$(GENDIR)/vendor/libmodbus",  # For config.h
        ],
        "//conditions:default": [],
    }),
    defines = select({
        "@platforms//os:windows": [
            "HAVE_CONFIG_H",
            "_WIN32_WINNT=0x0600",
            "MODBUS_API=",  # Override MODBUS_API for static linking
            "MODBUS_STATIC",  # Force static mode
        ],
        "//conditions:default": [],
    }),
    includes = select({
        "@platforms//os:windows": [
            ".",  # Generated files - allows modbus/modbus.h to be found
        ],
        "//conditions:default": [],
    }),
    linkopts = select({
        "@platforms//os:windows": ["ws2_32.lib"],
        "//conditions:default": [],
    }),
    strip_include_prefix = select({
        "@platforms//os:windows": "",
        "//conditions:default": "",
    }),
    deps = select({
        "@platforms//os:windows": [],
        "//conditions:default": [":libmodbus_unix"],
    }),
    visibility = ["//visibility:public"],
)
# Create Windows config.h header
genrule(
    name = "generate_config_h",
    outs = ["config.h"],
    cmd = """
cat > $@ << 'EOF'
#ifndef CONFIG_H
#define CONFIG_H

/* Package information */
#define PACKAGE_NAME "libmodbus"
#define PACKAGE_VERSION "3.1.11"
#define VERSION "3.1.11"

/* Windows platform configuration */
#define _WIN32_WINNT 0x0600  /* Windows 7+ */

/* Disable Unix-specific features not available on Windows */
#define HAVE_DECL_TIOCSRS485 0
#define HAVE_DECL_TIOCM_RTS 0

#endif
EOF""",
)

# Create modbus-version.h header using upstream template
genrule(
    name = "generate_version_h",
    srcs = ["libmodbus/src/modbus-version.h.in"],
    outs = ["modbus/modbus-version.h"],
    cmd = """
sed -e 's/@LIBMODBUS_VERSION_MAJOR@/3/g' \
    -e 's/@LIBMODBUS_VERSION_MINOR@/1/g' \
    -e 's/@LIBMODBUS_VERSION_MICRO@/11/g' \
    -e 's/@LIBMODBUS_VERSION@/3.1.11/g' \
    $(location libmodbus/src/modbus-version.h.in) > $@
""",
)

# Copy and modify ALL headers and sources for static linking
genrule(
    name = "prepare_static_sources",
    srcs = [
        "libmodbus/src/modbus.h",
        "libmodbus/src/modbus-tcp.h",
        "libmodbus/src/modbus-rtu.h",
        "libmodbus/src/modbus-private.h",
        "libmodbus/src/modbus-tcp-private.h",
        "libmodbus/src/modbus-rtu-private.h",
        "libmodbus/src/modbus.c",
        "libmodbus/src/modbus-data.c",
        "libmodbus/src/modbus-rtu.c",
        "libmodbus/src/modbus-tcp.c",
    ],
    outs = [
        "modbus/modbus.h",
        "modbus/modbus-tcp.h",
        "modbus/modbus-rtu.h",
        "modbus-private.h",
        "modbus-tcp-private.h",
        "modbus-rtu-private.h",
        "src/modbus.c",
        "src/modbus-data.c",
        "src/modbus-rtu.c",
        "src/modbus-tcp.c",
    ],
    cmd = select({
        "@platforms//os:windows": """
# Copy and patch modbus.h to respect pre-defined MODBUS_API
sed '/#if defined(_MSC_VER)/,/#endif/{
    /#if defined(_MSC_VER)/i\\
#ifndef MODBUS_API
    /#endif/a\\
#endif
}' $(location libmodbus/src/modbus.h) > $(@D)/modbus/modbus.h
cp $(location libmodbus/src/modbus-tcp.h) $(@D)/modbus/modbus-tcp.h
cp $(location libmodbus/src/modbus-rtu.h) $(@D)/modbus/modbus-rtu.h
# Fix private headers to use correct modbus.h path
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-private.h) > $(@D)/modbus-private.h
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-tcp-private.h) > $(@D)/modbus-tcp-private.h
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-rtu-private.h) > $(@D)/modbus-rtu-private.h

# Copy source files and fix their includes to use our fixed headers
sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus.c) > $(@D)/src/modbus.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus.c

sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus-data.c) > $(@D)/src/modbus-data.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus-data.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus-data.c

sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus-rtu.c) > $(@D)/src/modbus-rtu.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus-rtu.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus-rtu.c

sed 's|#include "modbus.h"|#include "../modbus/modbus.h"|g' $(location libmodbus/src/modbus-tcp.c) > $(@D)/src/modbus-tcp.c
sed -i 's|#include "modbus-tcp.h"|#include "../modbus/modbus-tcp.h"|g' $(@D)/src/modbus-tcp.c
sed -i 's|#include "modbus-rtu.h"|#include "../modbus/modbus-rtu.h"|g' $(@D)/src/modbus-tcp.c
""",
        "//conditions:default": """
# Unix/Mac - same processing as Windows for consistency
# Copy public headers to modbus/ directory
cp $(location libmodbus/src/modbus.h) $(@D)/modbus/modbus.h
cp $(location libmodbus/src/modbus-tcp.h) $(@D)/modbus/modbus-tcp.h
cp $(location libmodbus/src/modbus-rtu.h) $(@D)/modbus/modbus-rtu.h

# Fix private headers to use modbus/modbus.h path
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-private.h) > $(@D)/modbus-private.h
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-tcp-private.h) > $(@D)/modbus-tcp-private.h
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g' $(location libmodbus/src/modbus-rtu-private.h) > $(@D)/modbus-rtu-private.h

# Fix source files to use modbus/modbus.h path
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus.c) > $(@D)/src/modbus.c
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus-data.c) > $(@D)/src/modbus-data.c
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus-rtu.c) > $(@D)/src/modbus-rtu.c
sed 's|#include "modbus.h"|#include "modbus/modbus.h"|g; s|#include "modbus-tcp.h"|#include "modbus/modbus-tcp.h"|g; s|#include "modbus-rtu.h"|#include "modbus/modbus-rtu.h"|g' $(location libmodbus/src/modbus-tcp.c) > $(@D)/src/modbus-tcp.c
""",
    }),
)

# Generate config.h for Unix
genrule(
    name = "generate_unix_config_h",
    outs = ["unix/config.h"],
    cmd = """
cat > $@ << 'EOF'
#ifndef LIBMODBUS_CONFIG_H
#define LIBMODBUS_CONFIG_H

#define PACKAGE_NAME "libmodbus"
#define PACKAGE_VERSION "3.1.11"
#define VERSION "3.1.11"

#define HAVE_ARPA_INET_H 1
#define HAVE_ERRNO_H 1
#define HAVE_FCNTL_H 1
#define HAVE_LIMITS_H 1
#define HAVE_NETDB_H 1
#define HAVE_NETINET_IN_H 1
#define HAVE_NETINET_TCP_H 1
#define HAVE_SYS_IOCTL_H 1
#define HAVE_SYS_SOCKET_H 1
#define HAVE_SYS_TIME_H 1
#define HAVE_SYS_TYPES_H 1
#define HAVE_TERMIOS_H 1
#define HAVE_TIME_H 1
#define HAVE_UNISTD_H 1
#define HAVE_STDINT_H 1
#define HAVE_INTTYPES_H 1

#define HAVE_GETADDRINFO 1
#define HAVE_GETTIMEOFDAY 1
#define HAVE_INET_NTOP 1
#define HAVE_INET_PTON 1
#define HAVE_SELECT 1
#define HAVE_SOCKET 1
#define HAVE_STRERROR 1
#define HAVE_STRLCPY 1

#define HAVE_DECL_TIOCM_RTS 1
#define HAVE_DECL_TIOCSRS485 0

#endif
EOF""",
)

# Generate modbus-version.h for Unix using upstream template
genrule(
    name = "generate_unix_version_h",
    srcs = ["libmodbus/src/modbus-version.h.in"],
    outs = ["unix/modbus-version.h"],
    cmd = """
sed -e 's/@LIBMODBUS_VERSION_MAJOR@/3/g' \
    -e 's/@LIBMODBUS_VERSION_MINOR@/1/g' \
    -e 's/@LIBMODBUS_VERSION_MICRO@/11/g' \
    -e 's/@LIBMODBUS_VERSION@/3.1.11/g' \
    $(location libmodbus/src/modbus-version.h.in) > $@
""",
)

# Unified cc_library for all platforms
cc_library(
    name = "libmodbus",
    srcs = select({
        "@platforms//os:windows": [
            ":prepare_static_sources",
            ":generate_config_h",
        ],
        "//conditions:default": [
            ":prepare_static_sources",
            ":generate_unix_config_h",
        ],
    }),
    hdrs = select({
        "@platforms//os:windows": [
            ":prepare_static_sources",
            ":generate_version_h",
        ],
        "//conditions:default": [
            ":prepare_static_sources",
            ":generate_version_h",
        ],
    }),
    copts = select({
        "@platforms//os:windows": [
            "/DHAVE_CONFIG_H",
            "/D_WIN32_WINNT=0x0600",
            "/I$(GENDIR)/vendor/libmodbus",  # For config.h
        ],
        "//conditions:default": [
            "-DHAVE_CONFIG_H",
            "-DIPTOS_LOWDELAY=0x10",
        ],
    }),
    defines = select({
        "@platforms//os:windows": [
            "HAVE_CONFIG_H",
            "_WIN32_WINNT=0x0600",
            "MODBUS_API=",  # Override MODBUS_API for static linking
            "MODBUS_STATIC",  # Force static mode
        ],
        "//conditions:default": [],
    }),
    includes = select({
        "@platforms//os:windows": [
            ".",  # Allows modbus/modbus.h to be found
        ],
        "//conditions:default": [
            ".",  # Allows modbus/modbus.h to be found
            "unix",  # For generated config.h
        ],
    }),
    linkopts = select({
        "@platforms//os:windows": ["ws2_32.lib"],
        "//conditions:default": [],
    }),
    visibility = ["//visibility:public"],
)

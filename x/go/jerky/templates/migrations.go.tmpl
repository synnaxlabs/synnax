// Code generated by jerky. DO NOT EDIT.

package types

import (
	"github.com/synnaxlabs/x/jerky/migrate"
	"google.golang.org/protobuf/proto"
)

// {{ .TypeName }}Migrations is the migration registry.
var {{ .TypeName }}Migrations = &migrate.Registry{
	TypeName:       "{{ .TypeName }}",
	CurrentVersion: {{ .CurrentVersion }},
	Migrations: []migrate.Migration{
{{- range .Migrations }}
		{FromVersion: {{ .FromVersion }}, ToVersion: {{ .ToVersion }}, Migrate: migrate{{ $.TypeName }}V{{ .FromVersion }}ToV{{ .ToVersion }}},
{{- end }}
	},
}
{{- range .Migrations }}

func migrate{{ $.TypeName }}V{{ .FromVersion }}ToV{{ .ToVersion }}(data []byte) ([]byte, error) {
{{- if eq .FromVersion 0 }}
	// V0 = msgpack, handled by gorp layer fallback
	// If we get here, data should already be proto
	var pb {{ $.TypeName }}V{{ .ToVersion }}
	if err := proto.Unmarshal(data, &pb); err != nil {
		return nil, err
	}
	return data, nil
{{- else }}
	var old {{ $.TypeName }}V{{ .FromVersion }}
	if err := proto.Unmarshal(data, &old); err != nil {
		return nil, err
	}
	new := {{ $.TypeName }}V{{ .ToVersion }}{
{{- range .CommonFields }}
		{{ . }}: old.{{ . }},
{{- end }}
	}
	// Hook for custom field mappings (implement in migrations_custom.go)
	Migrate{{ $.TypeName }}V{{ .FromVersion }}ToV{{ .ToVersion }}Hook(&old, &new)
	return proto.Marshal(&new)
{{- end }}
}
{{- end }}

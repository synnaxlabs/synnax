// Code generated by jerky. DO NOT EDIT.

package {{ .SubPackageName }}

import (
	"github.com/synnaxlabs/x/jerky/migrate"
	"github.com/vmihailenco/msgpack/v5"
	"google.golang.org/protobuf/proto"
)

// Migrations is the migration registry for {{ .TypeName }}.
var Migrations = &migrate.Registry{
	TypeName:       "{{ .TypeName }}",
	CurrentVersion: {{ .CurrentVersion }},
	Migrations: []migrate.Migration{
{{- range .Migrations }}
		{FromVersion: {{ .FromVersion }}, ToVersion: {{ .ToVersion }}, Migrate: migrateV{{ .FromVersion }}ToV{{ .ToVersion }}},
{{- end }}
	},
}
{{- range .Migrations }}

func migrateV{{ .FromVersion }}ToV{{ .ToVersion }}(data []byte) ([]byte, error) {
{{- if eq .FromVersion 0 }}
	// Try proto first - data may already be migrated
	var pb V{{ .ToVersion }}
	if err := proto.Unmarshal(data, &pb); err == nil {
		return data, nil
	}

	// V0 = msgpack (pre-jerky legacy format)
	var v0 V0
	if err := msgpack.Unmarshal(data, &v0); err != nil {
		return nil, err
	}

	// Copy fields from v0 to v1 (types are identical)
	v1 := V{{ .ToVersion }}{
{{- range .V1Fields }}
		{{ .Name }}: v0.{{ .Name }},
{{- end }}
	}
	return proto.Marshal(&v1)
{{- else }}
	var old V{{ .FromVersion }}
	if err := proto.Unmarshal(data, &old); err != nil {
		return nil, err
	}
	new := V{{ .ToVersion }}{
{{- range .Fields }}
{{- if not .IsJerky }}
		{{ .Name }}: old.{{ .Name }},
{{- else if not .VersionChanged }}
		{{ .Name }}: old.{{ .Name }},
{{- else if .IsSlice }}
		{{ .Name }}: {{ lower .JerkyTypeName }}.MigrateV{{ .FromJerkyVersion }}ToV{{ .ToJerkyVersion }}Slice(old.{{ .Name }}),
{{- else if .IsMap }}
		{{ .Name }}: {{ lower .JerkyTypeName }}.MigrateV{{ .FromJerkyVersion }}ToV{{ .ToJerkyVersion }}Map(old.{{ .Name }}),
{{- else }}
		{{ .Name }}: {{ lower .JerkyTypeName }}.MigrateV{{ .FromJerkyVersion }}ToV{{ .ToJerkyVersion }}(old.{{ .Name }}),
{{- end }}
{{- end }}
	}
	// Hook for custom field mappings (implement in v{{ .FromVersion }}_to_v{{ .ToVersion }}.go)
	MigrateV{{ .FromVersion }}ToV{{ .ToVersion }}Hook(&old, &new)
	return proto.Marshal(&new)
{{- end }}
}
{{- end }}

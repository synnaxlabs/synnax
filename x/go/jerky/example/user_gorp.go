// Code generated by jerky. DO NOT EDIT.

package example

import (
	"github.com/synnaxlabs/x/jerky/example/types"
	"github.com/google/uuid"
	"time"
	"github.com/synnaxlabs/x/telem"
	"github.com/vmihailenco/msgpack/v5"
	"google.golang.org/protobuf/proto"
)

// MarshalGorp serializes a User to bytes using protobuf.
func (m User) MarshalGorp() ([]byte, error) {
	return proto.Marshal(&types.User{
		Key: m.Key.String(),
		ID: uint32(m.ID),
		Name: m.Name,
		Email: m.Email,
		Age: m.Age,
		Active: m.Active,
		Balance: m.Balance,
		CreatedAt: m.CreatedAt.UnixNano(),
		LastSeen: int64(m.LastSeen),
		Tags: m.Tags,
		Role: m.Role,
		Verified: m.Verified,
		Score: m.Score,
		Department: m.Department,
	})
}

// UnmarshalGorp deserializes bytes into a User.
// It expects data to be in the current proto format. Older versions should be
// migrated at startup using UserMigrator before normal operation.
func (m *User) UnmarshalGorp(data []byte) error {
	var pb types.User
	if err := proto.Unmarshal(data, &pb); err == nil {
		var err error
		m.Key, err = uuid.Parse(pb.Key)
		if err != nil {
			return err
		}
		m.ID = UserID(pb.ID)
		m.Name = pb.Name
		m.Email = pb.Email
		m.Age = pb.Age
		m.Active = pb.Active
		m.Balance = pb.Balance
		m.CreatedAt = time.Unix(0, pb.CreatedAt)
		m.LastSeen = telem.TimeStamp(pb.LastSeen)
		m.Tags = pb.Tags
		m.Role = pb.Role
		m.Verified = pb.Verified
		m.Score = pb.Score
		m.Department = pb.Department
		return nil
	}
	// Fall back to msgpack for pre-jerky (legacy) format.
	// Note: This only handles pre-jerky data, not older proto versions.
	// Run migrations at startup to convert old proto versions.
	return msgpack.Unmarshal(data, m)
}
